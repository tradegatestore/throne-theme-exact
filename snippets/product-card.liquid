{% comment %}
  Premium Product Card Snippet
  Renders individual product cards with hover effects and quick actions
{% endcomment %}

{%- liquid
  assign product_item = product | default: card_product
  assign media_aspect_ratio = media_aspect_ratio | default: 'adapt'
  assign show_secondary_image = show_secondary_image | default: true
  assign show_vendor = show_vendor | default: false
  assign show_rating = show_rating | default: false
  assign lazy_load = lazy_load | default: true
-%}

<div class="card-wrapper product-card-wrapper underline-links-hover" data-product-id="{{ product_item.id }}">
  <div class="card card--standard card--media"
    style="--ratio-percent: {{ 1 | divided_by: media_aspect_ratio | times: 100 }}%;">
    <div class="card__inner color-background-2 ratio"
      style="--ratio-percent: {% if media_aspect_ratio == 'adapt' and product_item.featured_media %}{{ 1 | divided_by: product_item.featured_media.aspect_ratio | times: 100 }}%{% else %}100%{% endif %};">
      
      {%- if product_item.featured_media -%}
        <div class="card__media">
          <div class="media media--transparent media--hover-effect">
            {%- if lazy_load -%}
              {{ product_item.featured_media | image_url: width: 1500 | image_tag:
                loading: 'lazy',
                sizes: '(min-width: 1200px) 367px, (min-width: 750px) calc((100vw - 130px) / 3), calc((100vw - 50px) / 2)',
                widths: '165, 360, 533, 720, 940, 1066',
                class: 'motion-reduce card-image-primary'
              }}
            {%- else -%}
              {{ product_item.featured_media | image_url: width: 1500 | image_tag:
                sizes: '(min-width: 1200px) 367px, (min-width: 750px) calc((100vw - 130px) / 3), calc((100vw - 50px) / 2)',
                widths: '165, 360, 533, 720, 940, 1066',
                class: 'motion-reduce card-image-primary'
              }}
            {%- endif -%}

            {%- if product_item.media[1] != nil and show_secondary_image -%}
              {{ product_item.media[1] | image_url: width: 1500 | image_tag:
                loading: 'lazy',
                sizes: '(min-width: 1200px) 367px, (min-width: 750px) calc((100vw - 130px) / 3), calc((100vw - 50px) / 2)',
                widths: '165, 360, 533, 720, 940, 1066',
                class: 'motion-reduce card-image-secondary'
              }}
            {%- endif -%}
          </div>
        </div>
      {%- else -%}
        <div class="card__content">
          <div class="card__information">
            <h3 class="card__heading">
              <a href="{{ product_item.url }}" class="full-unstyled-link">
                {{ product_item.title | truncate: 50 | escape }}
              </a>
            </h3>
          </div>
        </div>
      {%- endif -%}

      {%- if product_item.available == false -%}
        <div class="card__badge badge badge--bottom-left color-inverse">
          <span>{{ 'products.product.sold_out' | t }}</span>
        </div>
      {%- elsif product_item.compare_at_price > product_item.price -%}
        <div class="card__badge badge badge--bottom-left color-accent-1">
          {%- assign savings = product_item.compare_at_price | minus: product_item.price | times: 100 | divided_by: product_item.compare_at_price -%}
          <span>-{{ savings }}%</span>
        </div>
      {%- endif -%}
    </div>

    <div class="card__content">
      <div class="card__information">
        {%- if show_vendor -%}
          <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
          <div class="caption-with-letter-spacing light">{{ product_item.vendor }}</div>
        {%- endif -%}

        <h3 class="card__heading h5">
          <a href="{{ product_item.url }}" class="full-unstyled-link" aria-label="{{ product_item.title | escape }}">
            {{ product_item.title | truncate: 50 | escape }}
          </a>
        </h3>

        <div class="card-information">
          {%- if show_rating and product_item.metafields.reviews.rating.value != blank -%}
            {% liquid
              assign rating_decimal = 0
              assign decimal = product_item.metafields.reviews.rating.value.rating | modulo: 1
              if decimal >= 0.3 and decimal <= 0.7
                assign rating_decimal = 0.5
              elsif decimal > 0.7
                assign rating_decimal = 1
              endif
            %}
            <div class="rating" role="img" aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: product_item.metafields.reviews.rating.value, rating_max: product_item.metafields.reviews.rating.value.scale_max }}">
              <span aria-hidden="true" class="rating-star color-icon-text" style="--rating: {{ product_item.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ product_item.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};">
              </span>
            </div>
            <p class="rating-text caption">
              <span aria-hidden="true">{{ product_item.metafields.reviews.rating.value }} / {{ product_item.metafields.reviews.rating.value.scale_max }}</span>
            </p>
            <p class="rating-count caption">
              <span aria-hidden="true">({{ product_item.metafields.reviews.rating_count }})</span>
              <span class="visually-hidden">{{ product_item.metafields.reviews.rating_count }} {{ 'accessibility.total_reviews' | t }}</span>
            </p>
          {%- endif -%}

          <span class="caption-large light">{{ block.settings.description | escape }}</span>
          {% render 'price', product: product_item, price_class: '' %}
        </div>
      </div>

      <div class="card__actions">
        <div class="quick-add no-js-hidden">
          {%- if product_item.variants.size == 1 -%}
            <product-form>
              {%- form 'product', product_item, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" value="{{ product_item.selected_or_first_available_variant.id }}" disabled>
                <button
                  id="quick-add-{{ product_item.id }}"
                  type="submit"
                  name="add"
                  class="quick-add__submit button button--full-width button--secondary"
                  aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product_item.title | escape }}"
                  {% if product_item.selected_or_first_available_variant.available == false %}disabled{% endif %}
                >
                  <span>{{ 'products.product.add_to_cart' | t }}</span>
                  <span class="sold-out-message hidden">
                    {{ 'products.product.sold_out' | t }}
                  </span>
                  <div class="loading-overlay__spinner hidden">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </button>
              {%- endform -%}
            </product-form>
          {%- else -%}
            <modal-opener data-modal="#QuickAdd-{{ product_item.id }}">
              <button
                id="quick-add-{{ product_item.id }}"
                type="button"
                class="quick-add__submit button button--full-width button--secondary"
                aria-label="{{ 'products.product.choose_options' | t }}: {{ product_item.title | escape }}"
                aria-haspopup="dialog"
              >
                <span>{{ 'products.product.choose_options' | t }}</span>
                <div class="loading-overlay__spinner hidden">
                  <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </div>
              </button>
            </modal-opener>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
</div>
